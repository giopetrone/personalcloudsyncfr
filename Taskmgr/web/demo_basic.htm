
      <html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
        <title>Jalava : Web-based Diagram Editor</title>
        <script language="JavaScript" src="./js/Jalava.js"></script>
        <script language="JavaScript">
            // pezzo timer
            var c=0;
            var t;
            var timer_is_on=0;
            var nuovaVersione = 0;

            


            function timedCount()
            {
                document.getElementById('txt').value=c;
                nuovaVersione = 1;
                loadDiagram(null);
                c=c+1;
                t=setTimeout("timedCount()",10000);
            }

            function doTimer()
            {
                if (!timer_is_on)
                {
                    timer_is_on=1;
                    timedCount();
                }
            }
            // fine pezzo timer
            function saveDiagram(param){
                // if (window.event.type == "click") {
               // alert(param != 0);
                //   }
                // var url1 = "http://marinoflow.appspot.com/nuovastr.txt";
                var diagramName = document.getElementById('area').value;
                if (diagramName.length ==0) {
                    alert("Missing diagram name");
                    return;
                }
                var url1 = "./SaveServlet";
                var jsonString = Jalava.diagram.persist();
                if (confirm(jsonString)) {
                    // do things if OK
                }
                objXml = new XMLHttpRequest();
                objXml.open("POST",url1,false);
                objXml.setRequestHeader('Content-Type',"text/plain");
                objXml.setRequestHeader('filenamemio',diagramName);
                objXml.send(jsonString);
                str = objXml.responseText;
                confirm("RISP from server: " +str);
            }

            function crepa() {
                while (Jalava.diagram.container.childNodes.length >= 1 ){
                    Jalava.diagram.container.removeChild( Jalava.diagram.container.firstChild );
                }
                Jalava.diagram = new Diagram(220, 100, "550", "600");
            }

            function update(str){
            //    var msg = "update nuova stringa ? ";
            //    alert(msg + "|" + str + "|");
                if (nuovaVersione  == 1) {
                    nuovaVersione = 0;
                    if (str.length == 0) {
                        return;
                    }
                    var answer = confirm("vuoi nuova versione?");
                    if (answer){
                        crepa();
                        Jalava.diagram.load(str);
                    }
                } else {
                    crepa();
                    Jalava.diagram.load(str);
                }
            }

            function loadDiagram(param){
                var diagramName = document.getElementById('area').value;
                if (diagramName.length ==0) {
                    alert("Missing diagram name");
                    return;
                }

              //  confirm("ciclico? "+ param == null);

                var url1 = "./LoadServlet";
                objXml = new XMLHttpRequest();
                objXml.onreadystatechange  = function()
                {
                    if(objXml.readyState  == 4)
                    {
                        if(objXml.status  == 200) {
                            str = objXml.responseText;
                            update(str);
                        } else {}

                    }
                };
                objXml.open("GET",url1,true);
                objXml.setRequestHeader('Content-Type',"text/plain");
                objXml.setRequestHeader('filenamemio',diagramName);
                if (param == null) {
                    objXml.setRequestHeader('refresh',"true");
                }
                objXml.send(null);
            }


            function loadLocal(){


              //  confirm("ciclico? "+ param == null);

                var url1 = "./SubServlet";
                objXml = new XMLHttpRequest();
                objXml.onreadystatechange  = function()
                {
                    if(objXml.readyState  == 4)
                    {
                        if(objXml.status  == 200) {
                            str = objXml.responseText;
                            update(str);
                        } else {}

                    }
                };
                objXml.open("GET",url1,true);
                objXml.setRequestHeader('Content-Type',"text/plain");
                objXml.setRequestHeader('filenamemio');
                if (param == null) {
                    objXml.setRequestHeader('refresh',"true");
                }
                objXml.send(null);
            }








            





            function dodo(){
                var url = "/nstr.txt";

                objXml = new XMLHttpRequest();
                objXml.open("GET",url,false);
                objXml.send(null);
                str = objXml.responseText;
                confirm("ECCO " +str);
                Jalava.diagram.load(str);
            }

            function dada(){
                var url1 = "./nuovastr.txt";
                var jsonString = Jalava.diagram.persist();
                if (confirm(jsonString)) {
                    // do things if OK
                }
                objXml = new XMLHttpRequest();
                objXml.open("POST",url1,false);
                objXml.setRequestHeader('Content-Type',"text/plain");
                objXml.send(jsonString);
                str = objXml.responseText;
                confirm("RISP: " +str);
            }

            function dado(){
                var jsonString = Jalava.diagram.persist();
                confirm(jsonString);
            }


            // initialise Jalava here
            function initJalava(){
                Jalava.diagram = new Diagram(220, 100, "550", "600");
                var palette = new Palette(new FlowChartPaletteFactory(), 0, 100, 200);
                palette.addItem("rect", "Processing",  Palette.DRAG_TOOL, "./img/rect.gif");
                palette.addItem("connection", "Connection",  Palette.CLICK_TOOL, "./img/line.gif");
                palette.addItem("diamond", "Decision", Palette.DRAG_TOOL, "./img/diamond.gif");
                palette.addItem("parallel", "Input/Output", Palette.DRAG_TOOL, "./img/parallel.gif");
                palette.addItem("ellipse", "Connection Node", Palette.DRAG_TOOL, "./img/ellipse.gif");
                palette.addItem("rounded", "Start/End", Palette.DRAG_TOOL, "./img/ellipse.gif");
                Jalava.propertyPage = new FlowChartPropertyPage(20, 240, 10);
            }

            // start Jalava
            Jalava.addModule("FlowChartPaletteFactory");
            Jalava.addModule("FlowChartPropertyPage");
            Jalava.addModule("UrlGradientBlock");

            Jalava.start(initJalava);
          

        </script>

    </head>
    <body >

         <form name="saveandload" id="saveandload">

            <textarea rows="1" cols="5" name="area" id="area"> </textarea>
            <input type="button" value="saveDiagram" name="buttonSave" onClick="aa=1000; saveDiagram(aa);"/>
            <!--INPUT type="button" value="provalocale" name="buttonprova" onClick="dada();"-->
            <input type="button" value="loadDiagram" name="buttonLoad" onClick="aa=1000;loadDiagram(aa);"/>
            <input type="text" id="diagramName" name ="diagramName" value=""    />
            <input type="button" value="Start count!" onClick="doTimer();"/>
            <input type="text" id="txt" />
            <input type="button" value="See JSON" onclick="dado();"/>
            <input id="fileUtente" name="fileUtente" type="file" size="20"/>
            <textarea rows="1" cols="20" name="owner" id="owner">Inserisci Username </textarea>
            <input type="hidden"  id="share" name="share" value="Share DIAGRAM" onclick="childWindow=open('/newhtml.html','_blank','status=1,toolbar=1,scrollbars=1,width=600,height=800')"/>
           
            



          
        </form>

    </body>
</html>  